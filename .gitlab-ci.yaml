stages:
  - build
  - sync
  - test
  - benchmark
  - collector


include:
  - project: 'hive/haf'
    ref: develop
    file: '/scripts/ci-helpers/prepare_data_image_job.yml'


variables:
  # HAF
  HAF_POSTGRES_URL: postgresql://haf_app_admin@haf-instance:5432/haf_block_log
  HAF_ADMIN_POSTGRES_URL: postgresql://haf_admin@haf-instance:5432/haf_block_log
  # FF:
  FF_NETWORK_PER_BUILD: 1
  # GIT:
  GIT_DEPTH: 1
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: recursive


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| ANCHORS |>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.shared_tags:
  tags: &shared_tags
    - public-runner-docker
    - hived-for-tests


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| JOBS |>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

prepare_haf_image:
  stage: build
  extends: .prepare_haf_data_5m_image
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
    - when: manual
  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR/haf"
    REGISTRY_USER: "$HAF_IMG_BUILDER_USER"
    REGISTRY_PASS: $HAF_IMG_BUILDER_PASSWORD
  tags:
    - public-runner-docker
    - hived-for-tests


modify_haf_data:
  image: $CI_REGISTRY_IMAGE/ci_base_image:3.8
  stage: sync
  needs: [ 'prepare_haf_image' ]
  rules:
    - when: on_success
  services:
    - docker:20.10.10-dind
  variables:
    DOCKER_BUILDKIT: 1
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - echo "HAF image name $HAF_IMAGE_NAME"
    - docker run --name haf-instance $HAF_IMAGE_NAME
    - ./scripts/ci/wait-for-postgres.sh "haf-instance"
    - psql "${HAF_ADMIN_POSTGRES_URL}" -c "SELECT hive.app_create_context('hivemind_app');"
    - psql "${HAF_ADMIN_POSTGRES_URL}" -c 'SELECT * FROM hive.contexts;'
    - docker commit modified_image
    - docker images
    - docker save -o image.tar modified_image
  artifacts:
    paths:
      - image.tar
  tags: *shared_tags


read_haf_data:
  image: $CI_REGISTRY_IMAGE/ci_base_image:3.8
  stage: test
  needs: [ 'prepare_haf_image', 'modify_haf_data' ]
  script:
    - docker load -i image.tar
    - docker images
    - ./scripts/ci/wait-for-postgres.sh "haf-instance"
    - psql "${HAF_ADMIN_POSTGRES_URL}" -c 'SELECT MAX(num) FROM hive.blocks;'
    - psql "${HAF_ADMIN_POSTGRES_URL}" -c 'SELECT * FROM hive.contexts;'
  tags: *shared_tags


#<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<| JOBS |<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
